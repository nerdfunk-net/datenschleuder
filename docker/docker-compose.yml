services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: cockpit-postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-cockpit}
      - POSTGRES_USER=${POSTGRES_USER:-cockpit}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-cockpit123}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-cockpit}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s  # Allow time for initial database setup
    networks:
      - cockpit-network

  # Redis Message Broker
  redis:
    image: redis:7-alpine
    container_name: cockpit-redis
    command: redis-server --appendonly yes --requirepass ${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}
    environment:
      - REDIS_PASSWORD=${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s  # Allow time for initial AOF loading
    networks:
      - cockpit-network

  # Main Web Application (Frontend + Backend API)
  cockpit-web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.all-in-one
    container_name: cockpit-web
    ports:
      - "${FRONTEND_PORT:-3000}:${FRONTEND_PORT:-3000}"  # Frontend (Next.js)
      - "8000:8000"  # Backend (FastAPI)
    environment:
      # Backend Environment Variables
      - NAUTOBOT_URL=${NAUTOBOT_URL:-http://localhost:8080}
      - NAUTOBOT_TOKEN=${NAUTOBOT_TOKEN:-your_nautobot_token_here}
      - NAUTOBOT_TIMEOUT=${NAUTOBOT_TIMEOUT:-30}
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-this-in-production}
      - DATA_DIR=/app/data
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Database Configuration
      - DATENSCHLEUDER_DATABASE_HOST=postgres
      - DATENSCHLEUDER_DATABASE_PORT=5432
      - DATENSCHLEUDER_DATABASE_NAME=${POSTGRES_DB:-cockpit}
      - DATENSCHLEUDER_DATABASE_USERNAME=${POSTGRES_USER:-cockpit}
      - DATENSCHLEUDER_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-cockpit123}
      - DATENSCHLEUDER_DATABASE_SSL=false

      # Redis Configuration
      - DATENSCHLEUDER_REDIS_HOST=redis
      - DATENSCHLEUDER_REDIS_PORT=6379
      - DATENSCHLEUDER_REDIS_PASSWORD=${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}

      # Celery Configuration
      - CELERY_BROKER_URL=redis://:${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}@redis:6379/0

      # Frontend Environment Variables
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - BACKEND_URL=http://localhost:8000
      - FRONTEND_PORT=${FRONTEND_PORT:-3000}

      # Supervisord Config
      # Note: supervisord-web.conf is copied into the image during build (see Dockerfile.all-in-one)
      # It does NOT need to be mounted as a volume - it's already in the container at /etc/supervisor/conf.d/
      - SUPERVISORD_CONF=/etc/supervisor/conf.d/supervisord-web.conf
    volumes:
      # Persist data directory
      - cockpit_data:/app/data
      # Mount configuration directory for OIDC and other configs (read-write for user editing)
      - ../config:/app/config
      # Note: The config directory should contain:
      #   - oidc_providers.yaml (for SSO/OIDC configuration)
      #   - checkmk.yaml (for Check_MK settings)
      #   - snmp_mapping.yaml (for SNMP mappings)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:$$FRONTEND_PORT || curl -f http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - cockpit-network
    command: ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord-web.conf"]

  # Celery Worker (Background Tasks)
  cockpit-worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.all-in-one
    container_name: cockpit-worker
    environment:
      # Backend Environment Variables
      - NAUTOBOT_URL=${NAUTOBOT_URL:-http://localhost:8080}
      - NAUTOBOT_TOKEN=${NAUTOBOT_TOKEN:-your_nautobot_token_here}
      - NAUTOBOT_TIMEOUT=${NAUTOBOT_TIMEOUT:-30}
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-this-in-production}
      - DATA_DIR=/app/data
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Database Configuration
      - DATENSCHLEUDER_DATABASE_HOST=postgres
      - DATENSCHLEUDER_DATABASE_PORT=5432
      - DATENSCHLEUDER_DATABASE_NAME=${POSTGRES_DB:-cockpit}
      - DATENSCHLEUDER_DATABASE_USERNAME=${POSTGRES_USER:-cockpit}
      - DATENSCHLEUDER_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-cockpit123}
      - DATENSCHLEUDER_DATABASE_SSL=false

      # Redis Configuration
      - DATENSCHLEUDER_REDIS_HOST=redis
      - DATENSCHLEUDER_REDIS_PORT=6379
      - DATENSCHLEUDER_REDIS_PASSWORD=${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}

      # Celery Configuration
      - CELERY_BROKER_URL=redis://:${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}@redis:6379/0

      # Certificate Installation (for Docker environments)
      - INSTALL_CERTIFICATE_FILES=true

      # Supervisord Config
      # Note: supervisord-worker.conf is copied into the image during build (see Dockerfile.all-in-one)
      # It does NOT need to be mounted as a volume - it's already in the container at /etc/supervisor/conf.d/
      - SUPERVISORD_CONF=/etc/supervisor/conf.d/supervisord-worker.conf
    volumes:
      # Persist data directory
      - cockpit_data:/app/data
      # Mount configuration directory
      - ../config:/app/config
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      cockpit-web:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cockpit-network
    command: ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord-worker.conf"]

  # Celery Beat (Periodic Task Scheduler)
  cockpit-beat:
    build:
      context: ..
      dockerfile: docker/Dockerfile.all-in-one
    container_name: cockpit-beat
    environment:
      # Backend Environment Variables
      - NAUTOBOT_URL=${NAUTOBOT_URL:-http://localhost:8080}
      - NAUTOBOT_TOKEN=${NAUTOBOT_TOKEN:-your_nautobot_token_here}
      - NAUTOBOT_TIMEOUT=${NAUTOBOT_TIMEOUT:-30}
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-this-in-production}
      - DATA_DIR=/app/data
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Database Configuration
      - DATENSCHLEUDER_DATABASE_HOST=postgres
      - DATENSCHLEUDER_DATABASE_PORT=5432
      - DATENSCHLEUDER_DATABASE_NAME=${POSTGRES_DB:-cockpit}
      - DATENSCHLEUDER_DATABASE_USERNAME=${POSTGRES_USER:-cockpit}
      - DATENSCHLEUDER_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-cockpit123}
      - DATENSCHLEUDER_DATABASE_SSL=false

      # Redis Configuration
      - DATENSCHLEUDER_REDIS_HOST=redis
      - DATENSCHLEUDER_REDIS_PORT=6379
      - DATENSCHLEUDER_REDIS_PASSWORD=${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}

      # Celery Configuration
      - CELERY_BROKER_URL=redis://:${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}@redis:6379/0

      # Supervisord Config
      # Note: supervisord-beat.conf is copied into the image during build (see Dockerfile.all-in-one)
      # It does NOT need to be mounted as a volume - it's already in the container at /etc/supervisor/conf.d/
      - SUPERVISORD_CONF=/etc/supervisor/conf.d/supervisord-beat.conf
    volumes:
      # Persist data directory
      - cockpit_data:/app/data
      # Mount configuration directory
      - ../config:/app/config
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      cockpit-web:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cockpit-network
    command: ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord-beat.conf"]

  # Celery Worker - Specialized for Backup Tasks
  # This worker only processes tasks from the 'backup' queue
  # Can be deployed on a dedicated node for resource isolation
  cockpit-worker-backup:
    build:
      context: ..
      dockerfile: docker/Dockerfile.all-in-one
    container_name: cockpit-worker-backup
    environment:
      # Backend Environment Variables
      - NAUTOBOT_URL=${NAUTOBOT_URL:-http://localhost:8080}
      - NAUTOBOT_TOKEN=${NAUTOBOT_TOKEN:-your_nautobot_token_here}
      - NAUTOBOT_TIMEOUT=${NAUTOBOT_TIMEOUT:-30}
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-this-in-production}
      - DATA_DIR=/app/data
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Database Configuration
      - DATENSCHLEUDER_DATABASE_HOST=postgres
      - DATENSCHLEUDER_DATABASE_PORT=5432
      - DATENSCHLEUDER_DATABASE_NAME=${POSTGRES_DB:-cockpit}
      - DATENSCHLEUDER_DATABASE_USERNAME=${POSTGRES_USER:-cockpit}
      - DATENSCHLEUDER_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-cockpit123}
      - DATENSCHLEUDER_DATABASE_SSL=false

      # Redis Configuration
      - DATENSCHLEUDER_REDIS_HOST=redis
      - DATENSCHLEUDER_REDIS_PORT=6379
      - DATENSCHLEUDER_REDIS_PASSWORD=${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}

      # Celery Configuration
      - CELERY_BROKER_URL=redis://:${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${DATENSCHLEUDER_REDIS_PASSWORD:-changeme}@redis:6379/0

      # Queue Configuration - Process only 'backup' queue
      - CELERY_WORKER_QUEUE=backup

      # Certificate Installation (for Docker environments)
      - INSTALL_CERTIFICATE_FILES=true

      # Supervisord Config - Uses same config as general worker
      - SUPERVISORD_CONF=/etc/supervisor/conf.d/supervisord-worker.conf
    volumes:
      # Persist data directory
      - cockpit_data:/app/data
      # Mount configuration directory
      - ../config:/app/config
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      cockpit-web:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cockpit-network
    command: ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord-worker.conf"]
    # Optional: Uncomment to limit resources for this worker
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 2G

volumes:
  cockpit_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  cockpit-network:
    driver: bridge
